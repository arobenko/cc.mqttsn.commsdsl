<?xml version="1.0" encoding="UTF-8"?>
<schema name="mqttsn"
        id="1"
        endian="big">
    <fields>
        <enum name="MsgId" type="uint8" semanticType="messageId" hexAssign="true">
            <validValue name="Advertise" val="0x0" displayName="ADVERTISE" />
            <validValue name="Searchgw" val="0x1" displayName="SEARCHGW" />
            <validValue name="Gwinfo" val="0x2" displayName="GWINFO" />
            <validValue name="Connect" val="0x4" displayName="CONNECT" />
            <validValue name="Connack" val="0x5" displayName="CONNACK" />
            <validValue name="Willtopicreq" val="0x6" displayName="WILLTOPICREQ" />
            <validValue name="Willtopic" val="0x7" displayName="WILLTOPIC" />
            <validValue name="Willmsgreq" val="0x8" displayName="WILLMSGREQ" />
            <validValue name="Willmsg" val="0x9" displayName="WILLMSG" />
            <validValue name="Register" val="0xa" displayName="REGISTER" />
            <validValue name="Regack" val="0xb" displayName="REGACK" />
            <validValue name="Publish" val="0xc" displayName="PUBLISH" />
            <validValue name="Puback" val="0xd" displayName="PUBACK" />
            <validValue name="Pubcomp" val="0xe" displayName="PUBCOMP" />
            <validValue name="Pubrec" val="0xf" displayName="PUBREC" />
            <validValue name="Pubrel" val="0x10" displayName="PUBREL" />
            <validValue name="Subscribe" val="0x12" displayName="SUBSCRIBE" />
            <validValue name="Suback" val="0x13" displayName="SUBACK" />
            <validValue name="Unsubscribe" val="0x14" displayName="UNSUBSCRIBE" />
            <validValue name="Unsuback" val="0x15" displayName="UNSUBACK" />
            <validValue name="Pingreq" val="0x16" displayName="PINGREQ" />
            <validValue name="Pingresp" val="0x17" displayName="PINGRESP" />
            <validValue name="Disconnect" val="0x18" displayName="DISCONNECT" />
            <validValue name="Willtopicupd" val="0x1a" displayName="WILLTOPICUPD" />
            <validValue name="Willtopicresp" val="0x1b" displayName="WILLTOPICRESP" />
            <validValue name="Willmsgupd" val="0x1c" displayName="WILLMSGUPD" />
            <validValue name="Willmsgresp" val="0x1d" displayName="WILLMSGRESP" />
        </enum>
        <bundle name="MsgLengthField" displayName="Length">
            <int name="short" type="uint8" serOffset="1" displayOffset="1"/>
            <optional name="long">
                <field>
                    <int name="long" type="uint16" serOffset="3" displayOffset="3"/>
                </field>
                <cond value="$short = 0" />                    
            </optional>
        </bundle>  
        <int name="GwId" type="uint8" />  
        <int name="Duration" type="uint16" units="seconds" />        
        <int name="Radius" type="uint8">
            <special name="BroadcastToAll" val="0" />
        </int>  
        <data name="GwAdd" />
        <enum name="QoS" type="uint8">
            <validValue name="AtMostOnceDelivery" val="0" />
            <validValue name="AtLeastOnceDelivery" val="1" />
            <validValue name="ExactlyOnceDelivery" val="2" />
        </enum>
        <bitfield name="Flags">
            <enum name="TopicIdType" type="uint8" bitLength="2">
                <validValue name="NormalTopicId" val="0" />
                <validValue name="PredefinedTopicId" val="1" />
                <validValue name="TopicName" val="2" />
            </enum>
            <set name="mid" bitLength="3" displayName="_">
                <bit name="CleanSession" idx="0" />
                <bit name="Will" idx="1" />
                <bit name="Retain" idx="2" />
            </set>
            <enum name="QoS" reuse="QoS" bitLength="2" />
            <set name="high" bitLength="1" displayName="_">
                <bit name="Dup" idx="0" />
            </set>
        </bitfield>
        <int name="ProtocolId" type="uint8" defaultValue="0x1" validValue="0x1" />
        <string name="ClientId" />
        <enum name="ReturnCode" type="uint8">
            <validValue name="Accepted" val="0" />
            <validValue name="Congestion" val="1" />
            <validValue name="InvalidTopicId" val="2" />
            <validValue name="NotSupported" val="3" />
        </enum>
        <string name="WillTopic" />
        <data name="WillMsg" />
        <int name="TopicId" type="uint16" validRange="[0x0, 0xfffe]" />
        <int name="MessageId" type="uint16" displayName="MsgId"/>
        <string name="TopicName" />
        <data name="Data" />
    </fields>
    
    <frame name="Frame">
        <custom name="Length" field="MsgLengthField" />
        <id name="Id" field="MsgId" />
        <payload name="Data" />
    </frame>       
    
    <message name="Advertise" id="MsgId.Advertise" displayName="ADVERTISE" sender="server">
        <ref field="GwId" />
        <ref field="Duration" />
    </message>
    
    <message name="Searchgw" id="MsgId.Searchgw" displayName="SEARCHGW" sender="client">
        <ref field="Radius" />
    </message>   
    
    <message name="Gwinfo" id="MsgId.Gwinfo" displayName="GWINFO">
        <ref field="GwId" />
        <ref field="GwAdd" />
    </message>  
    
    <message name="Connect" id="MsgId.Connect" displayName="CONNECT" sender="client">
        <ref field="Flags" />
        <ref field="ProtocolId" />
        <ref field="Duration" />
        <ref field="ClientId" />
    </message>    
    
    <message name="Connack" id="MsgId.Connack" displayName="CONNACK" sender="server">
        <ref field="ReturnCode" />
    </message>        
    
    <message name="Willtopicreq" id="MsgId.Willtopicreq" displayName="WILLTOPICREQ" sender="server"/>
    
    <message name="Willtopic" id="MsgId.Willtopic" displayName="WILLTOPIC" sender="client">
        <ref field="Flags" />
        <ref field="WillTopic" />
    </message>    
    
    <message name="Willmsgreq" id="MsgId.Willmsgreq" displayName="WILLMSGREQ" sender="server"/>
    
    <message name="Willmsg" id="MsgId.Willmsg" displayName="WILLMSG" sender="client">
        <ref field="WillMsg" />
    </message> 
    
    <message name="Register" id="MsgId.Register" displayName="REGISTER">
        <ref field="TopicId" />
        <ref name="MsgId" field="MessageId" />
        <ref field="TopicName" />
    </message>     
    
    <message name="Regack" id="MsgId.Regack" displayName="REGACK">
        <ref field="TopicId" />
        <ref name="MsgId" field="MessageId" />
        <ref field="ReturnCode" />
    </message>   
    
    <message name="Publish" id="MsgId.Publish" displayName="PUBLISH">
        <ref field="Flags" />
        <ref field="TopicId" />
        <ref name="MsgId" field="MessageId" />
        <ref field="Data" />
    </message>                      
    
    <message name="Puback" id="MsgId.Puback" displayName="PUBACK">
        <ref field="TopicId" />
        <ref name="MsgId" field="MessageId" />
        <ref field="ReturnCode" />
    </message>      
    
    <message name="Pubrec" id="MsgId.Pubrec" displayName="PUBREC">
        <ref name="MsgId" field="MessageId" />
    </message>
    
    <message name="Pubrel" id="MsgId.Pubrel" displayName="PUBREL" copyFieldsFrom="Pubrec" />
    
    <message name="Pubcomp" id="MsgId.Pubcomp" displayName="PUBCOMP" copyFieldsFrom="Pubrec" />
    
    <message name="Subscribe" id="MsgId.Subscribe" displayName="SUBSCRIBE" sender="client">
        <ref field="Flags" />
        <ref name="MsgId" field="MessageId" />
        <optional name="TopicId" defaultMode="exists" displayExtModeCtrl="true">
            <ref  field="TopicId" />
        </optional>
        <optional name="TopicName" defaultMode="missing" displayExtModeCtrl="true">
            <ref field="TopicName" />
        </optional>
    </message>
    
    <message name="Suback" id="MsgId.Suback" displayName="SUBACK" sender="server">
        <ref field="Flags" />
        <ref field="TopicId" />
        <ref name="MsgId" field="MessageId" />
        <ref field="ReturnCode" />
    </message>     
    
    <message name="Unsubscribe" id="MsgId.Unsubscribe" displayName="UNSUBSCRIBE" copyFieldsFrom="Subscribe" sender="client"/>
    
    <message name="Unsuback" id="MsgId.Unsuback" displayName="UNSUBACK" sender="server">
        <ref name="MsgId" field="MessageId" />
    </message>   
    
    <message name="Pingreq" id="MsgId.Pingreq" displayName="PINGREQ">
        <ref field="ClientId" />
    </message>   
    
    <message name="Pingresp" id="MsgId.Pingresp" displayName="PINGRESP" /> 
    
    <message name="Disconnect" id="MsgId.Disconnect" displayName="DISCONNECT">
        <optional name="Duration" defaultMode="missing">
            <ref field="Duration" />
        </optional>
    </message>     
    
    <message name="Willtopicupd" id="MsgId.Willtopicupd" displayName="WILLTOPICUPD" sender="client">
        <ref field="WillTopic" />
    </message>   
    
    <message name="Willmsgupd" id="MsgId.Willmsgupd" displayName="WILLMSGUPD" sender="client">
        <ref field="WillMsg" />
    </message>     
    
    <message name="Willtopicresp" id="MsgId.Willtopicresp" displayName="WILLTOPICRESP" sender="server">
        <ref field="ReturnCode" />
    </message>       
    
    <message name="Willmsgresp" id="MsgId.Willmsgresp" displayName="WILLMSGRESP" sender="server">             
        <copyFieldsFrom value="Willtopicresp" />
    </message>
</schema>
